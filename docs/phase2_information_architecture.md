# Phase 2 情報設計・導線再設計ガイド

松屋向け計数管理ダッシュボードの Phase 2 では、主要指標に最短距離でたどり着ける情報設計と導線を再構築する。トップダッシュボードに経営 KPI を集約しつつ、売上・粗利・在庫・資金の 4 領域へタブでドリルダウンできる構造にすることで「1 画面 = 1 目的」を徹底し、経営者が迷わず判断できる体験を目指す。

## 1. サイトマップと階層構造

```
Dashboard (トップページ)
├── KPI カードセクション（売上総額 / 粗利 / 資金残高）
├── タブコンテナ
│   ├── 売上タブ
│   │   ├── トレンド（折れ線）
│   │   ├── 構成別（商品別・チャネル別などの棒グラフ）
│   │   └── 明細テーブル + CSV/PDF ダウンロード
│   ├── 粗利タブ
│   │   ├── トレンド（折れ線）
│   │   ├── 構成別（部門別・費目別など）
│   │   └── 明細テーブル + CSV/PDF ダウンロード
│   ├── 在庫タブ
│   │   ├── 在庫サマリ（重要商品指標カード）
│   │   ├── 在庫推移（折れ線 or 面グラフ）
│   │   └── 在庫明細 + 欠品アラート
│   └── 資金タブ
│       ├── 現預金推移（折れ線）
│       ├── 資金繰り予測（面グラフ）
│       └── 資金明細 + ダウンロード
└── 共通コントロール：期間選択・店舗選択・出力形式（CSV/PDF）
```

- トップページ全体を単一の Streamlit ページで構成し、タブ (`st.tabs`) 内で 4 領域の詳細を切り替える。
- 期間・店舗のフィルタと出力ボタンはタブとは独立した共通コンポーネントとして最上部に常時表示する。

## 2. トップダッシュボードの構成要素

### 2.1 KPI カードセクション

- 売上総額、粗利、資金残高の 3 枚を横並びで表示。`st.columns([1,1,1])` で均等配置し、視線の左から右への流れを作る。
- 各カードには「指標名」「最新値」「前期間比」「目標との差分」の 4 情報を掲載し、増減は矢印 + 色で示す。
- カード全体をクリック可能にし、該当タブへスムーズに遷移できるショートカットとする。

### 2.2 共通フィルタ & エクスポート

- フィルタバーを KPI カードの直下に配置し、期間プリセット（今月 / 先月 / 直近 30 日 / カスタム）と店舗セレクターを配置。
- フィルタ選択がタブをまたいで同期するように `st.session_state` を利用し、リロードなしで数値が再計算される UX を担保。
- エクスポートはチェックボックスで CSV / PDF を選択し、各タブのテーブルの隣にダウンロードボタンを表示。

### 2.3 タブコンテナ

- KPI カードで概要を把握 → タブで詳細を確認というドリルダウンの流れを崩さないよう、タブ見出しを KPI と同じ順序（売上 → 粗利 → 在庫 → 資金）で配置。
- タブ切替時にも KPI はスクロールせずに常に視界に入るよう、カード + フィルタ部分を `st.container()` で一塊にして上部に固定する。

## 3. タブ別詳細設計

### 3.1 売上タブ

1. **指標カード**（サブ KPI）: 売上累計、来客数、客単価などを 2 行目に追加で表示。トレンドと関連付けるために直近値を強調。
2. **トレンドグラフ**: 期間別売上推移を折れ線で表示し、前年比や前期比を破線で重ねる。粒度切替（週次 / 月次）をグラフ上部に配置。
3. **構成別グラフ**: 商品カテゴリ、チャネルなどを `st.selectbox` で切替できる棒グラフ。上位カテゴリはハイライト。
4. **明細テーブル**: 日付、店舗、チャネル、商品、売上、数量、粗利を含む。ソート・フィルタ・ダウンロード対応。

### 3.2 粗利タブ

1. **指標カード**: 粗利額、粗利率、営業利益の 3 指標を表示し、ターゲットラインとの差異を示す。
2. **トレンド**: 粗利・営業利益の推移を折れ線で描画。固定費配賦後の営業利益を重ねることで採算状況を一目で把握。
3. **構成分析**: 部門別または費目別の棒グラフ。赤字部門をアクセントカラーで警告し、費目別では固定費構造の内訳をスタック表示。
4. **明細テーブル**: 店舗別 P/L（売上、粗利、固定費、営業利益、粗利率）。赤字行は条件付き書式で背景を淡赤にする。

### 3.3 在庫タブ

1. **在庫サマリカード**: 安全在庫割れ商品数、在庫回転日数、滞留在庫金額など重要指標をカード化。閾値を超えた場合にアラートラベルを表示。
2. **在庫推移グラフ**: 在庫数量または在庫金額の推移を折れ線／面グラフで提示。安全在庫ラインを破線で示す。
3. **在庫明細 + アラート**: 商品別在庫表にステータス列を追加し、「欠品」「過剰」「適正」のラベルで分類。欠品アイテムのみを抽出するフィルタとダウンロードボタンを設置。

### 3.4 資金タブ

1. **資金残高カード**: 現預金残高、月末予測残高、必要運転資金の 3 指標を表示。資金繰り悪化時は警告バッジを表示。
2. **現預金推移**: 過去〜現在の資金残高を折れ線で表示。タブ内で他タブ同様に粒度切替可能。
3. **資金繰り予測**: 未来のキャッシュフローを面グラフで表し、仕入・家賃など主要キャッシュアウトを色分け。必要に応じて悲観 / 標準 / 楽観シナリオのトグルを用意。
4. **明細テーブル**: 入出金予定一覧を日付順に表示し、CSV/PDF エクスポートに対応。

## 4. ドリルダウンと導線ルール

- KPI カードのクリックで該当タブをアクティブにするショートカットを実装し、「概要 → 詳細」の導線を迷わせない。
- 各タブのグラフやテーブルにも次のアクションを設置。例: 売上構成グラフから商品明細をフィルタリングする `st.multiselect` を付ける。
- アラート表示（欠品、赤字、資金ショートなど）はタブ切替前に上部で通知し、該当タブへジャンプできるボタンを併設。

## 5. 情報優先度マトリクス

| 重要度 | コンポーネント | 意図 / 配置理由 |
| --- | --- | --- |
| 高 | KPI カード（売上総額・粗利総額・資金残高） | KGI に直結する最重要指標。ファーストビューの中心に配置し、増減を即座に判断できるよう数値と矢印を強調。 |
| 高 | 期間 / 店舗セレクター | 全データの前提条件。KPI の横に配置し、変更後の再計算が一目でわかるよう読み込みステータスを表示。 |
| 中 | タブナビゲーション | 詳細分析への入口。KPI と同じ横幅で配置し、選択中タブはアクセントカラーで強調。 |
| 中 | グラフセクション（トレンド・構成） | KPI の増減要因を理解するための可視化。各タブでカード直下に配置し、視線が自然に下方へ流れるようにする。 |
| 中 | 明細テーブル / ダウンロード | 数値検証・報告書作成に不可欠。グラフの下部全幅で配置し、右上にダウンロードボタンを添える。 |
| 低 | 補足情報・フッター | 情報ノイズを避けるため最下部に控えめに掲載。 |

## 6. ASCII ワイヤーフレーム

```
┌───────────────────────────────────────────────┐
│ [ 売上総額 ¥12,345,678 ▲12.3% ] [ 粗利 ¥5,432,100 ▼5.5% ] [ 資金残高 ¥8,900,000 ▲3.0% ] │
├───────────────────────────────────────────────┤
│ タブ: [ 売上 ] [ 粗利 ] [ 在庫 ] [ 資金 ]      期間: 今月▼  店舗: 本店▼           │
├───────────────────────────────────────────────┤
│ <折れ線グラフ: 月次売上推移>       <棒グラフ: 商品別売上構成>                  │
│                                                                           │
│ <明細テーブル (売上データ)  [CSV/PDF ダウンロード]>                             │
└───────────────────────────────────────────────┘
```

- ファーストビューで KPI とタブ見出し、フィルタが同時に視界に入るレイアウト。
- タブ内コンテンツは左右 2 カラム（グラフ + ハイライト）→ 全幅テーブルの順に配置し、情報の密度が徐々に高まる構成とする。

## 7. 実装メモ

- `render_dashboard_tab`（仮称）で KPI カードとタブコンテンツを 1 つの関数に集約する。各タブ内容はサブ関数化し、`st.tabs` で呼び出す。
- 期間・店舗フィルタは `st.session_state` に保存し、タブ間で共有する。`st.experimental_rerun()` は極力使わず、ウィジェットのコールバックで状態更新する。
- ダウンロードボタンは `report.csv_download` / `report.pdf_download` の既存ヘルパーを再利用し、ファイル名にタブ名・日付を付与する（例: `matsuya_sales_202404.csv`）。
- タブ切替時に毎回重い計算を走らせないよう、`st.cache_data` で売上・粗利・在庫・資金の集計結果を分離してキャッシュする。
- 画面幅が狭い場合は KPI カードを 2 行表示にフォールバックするなど、レスポンシブ性を高める余地を残す。

上記ガイドラインを実装に落とし込むことで、意思決定者が最小のクリックで必要な洞察へアクセスできるシンプルかつ強力なダッシュボード体験を提供できる。
