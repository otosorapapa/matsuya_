# 松屋向け「計数管理」Streamlitアプリ設計書

## 1. 目的と背景
- **目的**: 属人的なExcel集計を脱却し、松屋の経営者が店舗別の収支と在庫状況を日常的に把握できるWebアプリを構築する。
- **背景課題**:
  - 店舗別の売上・粗利・固定費の可視化ができておらず、意思決定が経験や勘に依存している。
  - 売上・在庫データの抽出に手作業が多く、最新情報へ即時アクセスできない。
  - 在庫と原価の情報が曖昧で、在庫圧縮や仕入最適化の検討がしづらい。
- **成果物**: Streamlitベースの計数管理ダッシュボード。マウス操作中心のUIで、フィルタ操作とタブ切り替えのみで主要な経営指標が参照できる。

## 2. 想定ユーザーと利用シナリオ
- **主利用者**: 松屋 経営者・店長クラス。
- **利用シーン**:
  1. 毎朝、前日の売上と在庫状況を確認。
  2. 週次・月次会議で店舗別損益と固定費をレビュー。
  3. 新施策（仕入調整・値付け・販促）前後のインパクトを損益分岐点シミュレーションで確認。
- **操作制約**: 基本的にマウス操作・プルダウン選択・スライダー調整のみで完結。

## 3. 全体アーキテクチャ
```
┌──────────────────────────────┐
│ Streamlit UI (app.py)                                         │
│  ├─ Sidebar filters (店舗, 期間, 商品カテゴリ, 出力形式など)     │
│  ├─ Main area tabs (売上分析 / 商品別分析 / 損益管理 / 在庫分析 /  │
│  │                  経営シミュレーション)                         │
│  └─ 帳票出力セクション                                          │
├──────────────────────────────┤
│ Data Services (data_loader.py, transformers.py)               │
│  ├─ CSV読込 & 検証                                              │
│  ├─ データ正規化 & 指標算出                                     │
│  ├─ キャッシュ (st.cache_data)                                 │
│  └─ 共通フィルタロジック                                       │
├──────────────────────────────┤
│ Local storage / Shared drive                                  │
│  └─ 売上・仕入CSV、在庫初期値CSV                                 │
└──────────────────────────────┘
```
- 初期段階は単一ユーザー運用を想定。CSVファイルはローカルもしくは共有ドライブから手動アップロード。
- Streamlitの再実行特性を活かし、ウィジェット操作に合わせてデータを再計算。

## 4. UI構成
### 4.1 レイアウト概要
- **サイドバー**: 共通フィルタと操作ボタンを常時表示。
- **メインエリア**: `st.tabs()` でタブ分け。初期表示は売上分析。
- **共通コンポーネント**: KPIカード (`st.metric`)、グラフ (Streamlit chart or Plotly)、データテーブル (`st.dataframe`)、ダウンロードボタン。

```
+--------------------------------------------------------------+
| サイドバー             |  [売上分析] [商品別分析] [損益管理] |
| ・店舗選択             |  [在庫分析] [経営シミュレーション]  |
| ・期間選択             |------------------------------------|
| ・商品カテゴリ選択     |  タブごとのコンテンツ               |
| ・表示オプション切替   |                                    |
| ・帳票出力ボタン       |                                    |
+--------------------------------------------------------------+
```

### 4.2 サイドバー詳細
| UI要素 | 内容 | 初期値/選択肢 |
| --- | --- | --- |
| ファイルアップローダ | 売上CSV、仕入CSV、在庫初期CSVのアップロード。| 未選択時はサンプルデータを利用可。|
| 店舗選択 | 単一選択 + 「全店舗」オプション。| `全店舗` |
| 期間選択 | 日付範囲 (`st.date_input`) または月単位 (`st.selectbox`).| 直近3ヶ月 |
| 商品カテゴリ | 全カテゴリ/個別カテゴリ。| `全カテゴリ` |
| 比較モード | 前年同月比/対前期比などの表示切替。| 前年同月比 |
| 帳票出力 | CSV/PDFのチェックボックスと「エクスポート」ボタン。| - |

## 5. タブ別機能要件
### 5.1 売上分析タブ
- **日次売上推移**: `st.line_chart` または Plotly Express `px.line`。マーカー表示・ツールチップで日次売上、前年比、件数。
- **月次売上推移**: `px.bar` で月次売上、`px.line` で前年同月比を重ねた複合グラフ。
- **KPIカード**: 当月売上累計、前年同期比、平均客単価、来客数、粗利率。
- **フィルタ連動**: サイドバーで店舗/期間/カテゴリ変更時に再描画。
- **エンプティケース**: データが存在しない場合は `st.info("該当データがありません")`。

### 5.2 商品別分析タブ
- **ABC分析**:
  1. 売上順にソート → 累積構成比計算。
  2. A/B/Cランクを閾値 (0.8, 0.9) で分類。
  3. グラフ: `px.bar` (売上) + `px.line` (累積構成比) のパレート図。
- **ランキング表**: 商品名、売上、粗利、数量、構成比、累積構成比、ランク。
- **上位商品ハイライト**: Aランク商品の前年比伸長率TOP3をカード表示。
- **カテゴリ別円グラフ**: `px.pie` でカテゴリ構成比。カテゴリ選択で商品ランキングを再計算。

### 5.3 損益管理タブ
- **店舗別損益表**:
  - 列: 店舗, 売上, 粗利額, 粗利率, 固定費 (入力 or CSV), 営業利益 (粗利額-固定費).
  - 表示: `st.dataframe` でソート・ハイライト (赤字は条件付き書式 `style.apply`).
- **店舗別グラフ**: `px.bar` で店舗別売上/粗利。赤字店舗は色分け。
- **固定費内訳入力**: `st.number_input` で家賃・人件費・光熱費などを編集。セッション状態に保持し、営業利益に反映。
- **損益分岐アラート**: 営業利益<0 の店舗に `st.warning`。

### 5.4 在庫分析タブ
- **在庫推定**:
  - 計算: `推定在庫 = 期首在庫 + 仕入数 - 販売数量`。
  - 入力: 期首在庫はCSVまたはサイドバーで入力。仕入数は仕入CSVから取得。
- **在庫回転率**: `年間販売数 / 平均在庫` をカテゴリ別に算出。
- **アドバイス表示**: ランク×在庫状況で簡易メッセージ (`Aランクかつ低在庫 → 補充推奨` 等)。`st.dataframe` にコメント列。
- **在庫ヒートマップ**: `px.density_heatmap` でカテゴリ×在庫水準を視覚化 (任意)。

### 5.5 経営シミュレーションタブ
- **損益分岐点計算**:
  - 入力: 粗利率スライダー (0.3〜0.8)、固定費スライダー (0〜5,000,000円)。
  - 出力: 損益分岐点売上 = 固定費 / 粗利率。`st.metric` + `px.line` で感度分析。
- **固定費シミュレーション**: 各費目のスライダー調整 → 合計固定費に反映。
- **利益目標逆算**: 目標利益を `st.number_input` で入力 → 必要売上 = (固定費 + 目標利益) / 粗利率。
- **シナリオ保存**: `st.button("シナリオを保存")` でシナリオ名とともにセッションに保持、ダウンロード可。

### 5.6 帳票出力共通機能
- **CSV出力**: `st.download_button` で現在の集計テーブルをCSV化。
- **PDF出力**: ReportLab or `pdfkit` + HTMLテンプレートでレポート生成。Streamlitの`download_button`で提供。
- **命名規則**: `matsuya_<tab名>_<yyyymmdd>.csv/pdf`。

## 6. データ構造
### 6.1 売上・仕入データ
| 列名 | 型 | 説明 |
| --- | --- | --- |
| date | datetime | 売上日。月次集計時は月初日で表現。|
| store | string | 店舗名（本店、福岡西店、唐津店、ECなど）。|
| category | string | 商品カテゴリ。|
| product | string | 商品名（省略可）。|
| sales_amount | float | 売上金額（税抜）。|
| sales_qty | float | 販売数量。|
| cogs_amount | float | 仕入・売上原価。|
| gross_profit | float | 粗利。未提供時は `sales_amount - cogs_amount`。|
| gross_margin | float | 粗利率 (=gross_profit/sales_amount)。|
| yoy_growth | float | 前年同日/同月比 (任意)。|

### 6.2 在庫データ
| 列名 | 型 | 説明 |
| --- | --- | --- |
| product | string | 商品名。|
| opening_stock | float | 期首在庫数量。|
| planned_purchase | float | 期間中仕入数量。|
| safety_stock | float | 任意の安全在庫基準。|

### 6.3 固定費マスタ
| 列名 | 型 | 説明 |
| --- | --- | --- |
| store | string | 店舗名。|
| rent | float | 家賃。|
| payroll | float | 人件費。|
| utilities | float | 光熱費。|
| marketing | float | 広告宣伝費。|
| other_fixed | float | その他固定費。|

## 7. データ処理フロー
1. **アップロード/サンプル読み込み** (`data_loader.load_sales_data`):
   - CSVを読み込み → 必要列の存在確認 → 欠損補完 (0埋め)。
   - 日付列は `pd.to_datetime` で正規化。
2. **データ整形** (`transformers.prepare_dataset`):
   - 商品階層の展開 (店舗-カテゴリ-商品 → 正規化行)。
   - `gross_profit`, `gross_margin`, `avg_unit_price = sales_amount / sales_qty` を計算。
3. **フィルタ適用** (`filters.apply_filters`):
   - 店舗・期間・カテゴリで`df.query`。
   - 前年比較が必要な場合は期間を1年シフトしたデータも抽出しマージ。
4. **集計関数**:
   - `analytics.sales_daily(df)` → 日次売上。
   - `analytics.sales_monthly(df)` → 月次売上＆前年比。
   - `analytics.abc_analysis(df)` → 商品別ランキング。
   - `analytics.store_profit(df, fixed_costs)` → 店舗別損益。
   - `analytics.inventory_estimate(df_sales, df_stock)` → 在庫推定。
   - `analytics.breakeven(gross_margin, fixed_cost)` → 損益分岐点。
5. **表示**: 各タブ関数で集計結果を可視化。

## 8. 実装モジュール構成案
```
/streamlit_app
├─ app.py                 # Streamlitエントリーポイント
├─ data_loader.py         # CSV読込 & バリデーション
├─ transformers.py        # データ整形・共通処理
├─ analytics/
│   ├─ __init__.py
│   ├─ sales.py           # 日次・月次・KPI
│   ├─ products.py        # ABC分析・カテゴリ集計
│   ├─ profitability.py   # 店舗別損益・損益分岐
│   ├─ inventory.py       # 在庫推定・回転率
│   └─ simulation.py      # シナリオ計算ロジック
├─ components/
│   ├─ sidebar.py         # サイドバーUI構築
│   └─ report.py          # 帳票生成 (CSV, PDF)
└─ assets/
    └─ sample_data/       # サンプルCSV
```
- 小規模のためシングルリポジトリ内で完結。`app.py` がタブ関数を呼び出す。
- 共通設定 (`config.py`) にサンプルファイルパスやデフォルト閾値を定義しても良い。

## 9. UX設計のポイント
- フォント・配色はStreamlitデフォルトテーマを基本。過度な装飾を避け、情報優先。
- グラフにはツールチップを付け、マウスホバーで詳細数値を表示。
- 重要指標は画面上部にカード表示し、初見でも指標が目に入るようにする。
- グラフと表を並べて表示（`st.columns`）し、数字とビジュアルの両方で状況把握を補助。
- エラーハンドリング: ファイル欠損・列名違いの際は `st.error` で原因を説明し、テンプレートCSVダウンロードリンクを提示。

## 10. テスト方針
- **データバリデーションテスト**: 想定列が揃っているか、自動計算の精度確認。
- **機能テスト**: 各タブに対してサンプルデータを利用した描画確認。Streamlitの`pytest`互換機能は限定的なため、ロジック部分を関数化して単体テストする。
- **UIテスト**: 主要ブラウザ（Chrome/Edge）でレンダリング崩れがないか目視確認。
- **パフォーマンステスト**: 1万行程度のCSVでレスポンスが許容範囲 (2-3秒以内) か確認。

## 11. デプロイ・運用
- **初期運用**: 社内PCで`streamlit run app.py`を実行しローカルアクセス。
- **共有運用**: 社内サーバ or Streamlit Community Cloudにデプロイ。必要に応じてパスワード保護。
- **データ更新**: 毎月/毎週CSVを差し替え。将来的にGoogle DriveやS3からの自動取得を検討。
- **バックアップ**: 帳票出力ファイルと元CSVを社内共有ドライブで管理。

## 12. 今後の拡張アイデア
1. **API連携**: POSや在庫管理システムとAPI接続し、手動CSVを廃止。
2. **通知機能**: 損益悪化や在庫過多時にメール/Slack通知。
3. **顧客分析タブ**: CRMデータが整った場合に顧客属性別分析を追加。
4. **需要予測**: 過去データから機械学習で予測売上・推奨在庫を算出。
5. **アクセス制御**: 店舗ごとに閲覧権限を分けるシンプルなログイン機構。

## 13. 導入スケジュールの目安
| フェーズ | 期間 | 主な作業 |
| --- | --- | --- |
| 要件確定 | 1週間 | データ項目・帳票要件の確認、CSVサンプル収集 |
| プロトタイプ | 2週間 | Streamlit UI骨組み + サンプルデータでグラフ作成 |
| 検証 & 調整 | 1週間 | ユーザレビュー、UI/指標調整、帳票テンプレート整備 |
| 本番運用開始 | 0.5週間 | CSV連携フロー確立、利用マニュアル作成 |

---
本設計書をベースに、サンプルデータを用いたプロトタイプ開発から着手し、松屋の意思決定に必要な数値可視化を迅速に提供する。
